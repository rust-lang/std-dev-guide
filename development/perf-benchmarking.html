<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Performance optimizations and benchmarking - Standard library developers Guide</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="Guide for standard library developers">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../about.html"><strong aria-hidden="true">1.</strong> About this Guide</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> Contributing to the standard libraries</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../development/building-and-debugging.html"><strong aria-hidden="true">2.1.</strong> Building and debugging</a></li><li class="chapter-item expanded "><a href="../development/perf-benchmarking.html" class="active"><strong aria-hidden="true">2.2.</strong> Performance optimizations and benchmarking</a></li><li class="chapter-item expanded "><a href="../development/how-to-write-documentation.html"><strong aria-hidden="true">2.3.</strong> Writing documentation</a></li><li class="chapter-item expanded "><a href="../development/feature-lifecycle.html"><strong aria-hidden="true">2.4.</strong> Feature lifecycle</a></li><li class="chapter-item expanded "><a href="../development/stabilization.html"><strong aria-hidden="true">2.5.</strong> Stabilizing a feature</a></li></ol></li><li class="chapter-item expanded "><a href="../breaking-changes/summary.html"><strong aria-hidden="true">3.</strong> Breaking changes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../breaking-changes/new-trait-impls.html"><strong aria-hidden="true">3.1.</strong> New trait implementations</a></li><li class="chapter-item expanded "><a href="../breaking-changes/prelude.html"><strong aria-hidden="true">3.2.</strong> Prelude</a></li><li class="chapter-item expanded "><a href="../breaking-changes/doc-changes.html"><strong aria-hidden="true">3.3.</strong> Doc changes</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Policies</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../policy/must-use.html"><strong aria-hidden="true">4.1.</strong> When to add #[must_use]</a></li><li class="chapter-item expanded "><a href="../policy/specialization.html"><strong aria-hidden="true">4.2.</strong> Specialization</a></li><li class="chapter-item expanded "><a href="../policy/inline.html"><strong aria-hidden="true">4.3.</strong> When to #[inline]</a></li><li class="chapter-item expanded "><a href="../policy/doc-alias.html"><strong aria-hidden="true">4.4.</strong> Doc alias policy</a></li><li class="chapter-item expanded "><a href="../policy/safety-comments.html"><strong aria-hidden="true">4.5.</strong> Safety comments policy</a></li><li class="chapter-item expanded "><a href="../policy/target-code.html"><strong aria-hidden="true">4.6.</strong> Reviewing target-specific code</a></li><li class="chapter-item expanded "><a href="../policy/extension-traits.html"><strong aria-hidden="true">4.7.</strong> Why the standard library uses extension traits</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Tricky situations</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../tricky/may-dangle.html"><strong aria-hidden="true">5.1.</strong> Drop and #[may_dangle]</a></li><li class="chapter-item expanded "><a href="../tricky/generics-and-unsafe.html"><strong aria-hidden="true">5.2.</strong> Generics and unsafe</a></li></ol></li><li class="chapter-item expanded "><a href="../team/summary.html"><strong aria-hidden="true">6.</strong> The library team</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../team/meetings.html"><strong aria-hidden="true">6.1.</strong> Meetings</a></li><li class="chapter-item expanded "><a href="../team/membership.html"><strong aria-hidden="true">6.2.</strong> Membership</a></li><li class="chapter-item expanded "><a href="../team/reviewing.html"><strong aria-hidden="true">6.3.</strong> Reviewing</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Standard library developers Guide</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rust-lang/std-dev-guide" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/rust-lang/std-dev-guide/edit/master/./src/development/perf-benchmarking.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="library-optimizations-and-benchmarking"><a class="header" href="#library-optimizations-and-benchmarking">Library optimizations and benchmarking</a></h1>
<p>Recommended reading: <a href="https://nnethercote.github.io/perf-book/title-page.html">The Rust performance book</a></p>
<h2 id="what-to-optimize"><a class="header" href="#what-to-optimize">What to optimize</a></h2>
<p>It's preferred to optimize code that shows up as significant in real-world code.
E.g. it's more beneficial to speed up <code>[T]::sort</code> than it is to shave off a small allocation in <code>Command::spawn</code>
because the latter is dominated by its syscall cost.</p>
<p>Issues about slow library code are labeled as <a href="https://github.com/rust-lang/rust/issues?q=is%3Aissue+is%3Aopen+label%3AI-slow+label%3AT-libs">I-slow T-libs</a>
and those about code size as <a href="https://github.com/rust-lang/rust/issues?q=is%3Aissue+is%3Aopen+label%3AI-heavy+label%3AT-libs">I-heavy T-libs</a></p>
<h2 id="vectorization"><a class="header" href="#vectorization">Vectorization</a></h2>
<p>Currently only baseline target features (e.g. SSE2 on x86_64-unknown-linux-gnu) can be used in core and alloc because
runtime feature-detection is only available in std.
Where possible the preferred way to achieve vectorization is by shaping code in a way that the compiler
backend's auto-vectorization passes can understand. This benefits user crates compiled with additional target features
when they instantiate generic library functions, e.g. iterators.</p>
<h2 id="rustc-perf"><a class="header" href="#rustc-perf">rustc-perf</a></h2>
<p>For parts of the standard library that are heavily used by rustc itself it can be convenient to use
<a href="https://github.com/rust-lang/rustc-perf/tree/master/collector#benchmarking">the benchmark server</a>.</p>
<p>Since it only measures compile-time but not runtime performance of crates it can't be used to benchmark for features
that aren't used by the compiler, e.g. floating point code, linked lists, mpsc channels, etc.
For those explicit benchmarks must be written or extracted from real-world code.</p>
<h2 id="built-in-microbenchmarks"><a class="header" href="#built-in-microbenchmarks">Built-in Microbenchmarks</a></h2>
<p>The built-in benchmarks use <a href="https://doc.rust-lang.org/nightly/unstable-book/library-features/test.html">cargo bench</a>
and can be found in the <code>benches</code> directory for <code>core</code> and <code>alloc</code> and in <code>test</code> modules in <code>std</code>.</p>
<p>The benchmarks are automatically executed run in a loop by <code>Bencher::iter</code> to average the runtime over many loop-iterations.
For CPU-bound microbenchmarks the runtime of a single iteration should be in the range of nano- to microseconds.</p>
<p>To run a specific  can be invoked without recompiling rustc
via <code>./x bench library/&lt;lib&gt; --stage 0 --test-args &lt;benchmark name&gt;</code>.</p>
<p><code>cargo bench</code> measures wall-time. This often is good enough, but small changes such as saving a few instructions
in a bigger function can get drowned out by system noise. In such cases the following changes can make runs more
reproducible:</p>
<ul>
<li>disable incremental builds in <code>config.toml</code></li>
<li>build std and the benchmarks with <code>RUSTFLAGS_BOOTSTRAP=&quot;-Ccodegen-units=1&quot;</code></li>
<li>ensure the system is as idle as possible</li>
<li><a href="https://man7.org/linux/man-pages/man8/setarch.8.html">disable ASLR</a></li>
<li><a href="https://man7.org/linux/man-pages/man1/taskset.1.html">pinning</a> the benchmark process to a specific core</li>
<li>change the CPU <a href="https://wiki.archlinux.org/title/CPU_frequency_scaling#Scaling_governors">scaling governor</a>
to a fixed-frequency one (<code>performance</code> or <code>powersave</code>)</li>
<li><a href="https://wiki.archlinux.org/title/CPU_frequency_scaling#Configuring_frequency_boosting">disable clock boosts</a>,
especially on thermal-limited systems such as laptops</li>
</ul>
<h2 id="standalone-tests"><a class="header" href="#standalone-tests">Standalone tests</a></h2>
<p>If <code>x</code> or the cargo benchmark harness get in the way it can be useful to extract the benchmark into a separate crate,
e.g. to run it under <code>perf stat</code> or cachegrind.</p>
<p>Build the standard library and link <a href="https://rustc-dev-guide.rust-lang.org/building/how-to-build-and-run.html#creating-a-rustup-toolchain">stage0-sysroot</a>
as rustup toolchain and then use that to build the standalone benchmark with a modified standard library.</p>
<p>If the std rebuild times are too long for fast iteration it can be useful to not only extract the benchmark but also
the code under test into a separate crate.</p>
<h2 id="running-under-perf-record"><a class="header" href="#running-under-perf-record">Running under perf-record</a></h2>
<p>If extracting the code into a separate crate is impractical one can first build the benchmark and then run it again
under <code>perf record</code> and then drill down to the benchmark kernel with <code>perf report</code>.</p>
<pre><code class="language-terminal ignore"># 1CGU to reduce inlining changes and code reorderings, debuginfo for source annotations
$ export RUSTFLAGS_BOOTSTRAP=&quot;-Ccodegen-units=1 -Cdebuginfo=2&quot;

# build benchmark without running it
$ ./x bench --stage 0 library/core/ --test-args skipallbenches

# run the benchmark under perf
$ perf record --call-graph dwarf -e instructions ./x bench --stage 0 library/core/ --test-args &lt;benchmark name&gt;
$ perf report
</code></pre>
<p>By renaming <code>perf.data</code> to keep it from getting overwritten by subsequent runs it can be later compared to runs with
a modified library with <code>perf diff</code>.</p>
<h2 id="comparing-assembly"><a class="header" href="#comparing-assembly">comparing assembly</a></h2>
<p>While <code>perf report</code> shows assembly of the benchmark code it can sometimes be difficult to get a good overview of what
changed, especially when multiple benchmarks were affected. As an alternative one can extract and diff the assembly
directly from the benchmark suite.</p>
<pre><code class="language-terminal ignore"># 1CGU to reduce inlining changes and code reorderings, debuginfo for source annotations
$ export RUSTFLAGS_BOOTSTRAP=&quot;-Ccodegen-units=1 -Cdebuginfo=2&quot;

# build benchmark libs
$ ./x bench --stage 0 library/core/ --test-args skipallbenches

# this should print something like the following
Running benches/lib.rs (build/x86_64-unknown-linux-gnu/stage0-std/x86_64-unknown-linux-gnu/release/deps/corebenches-2199e9a22e7b1f4a)

# get the assembly for all the benchmarks
$ objdump --source --disassemble --wide --no-show-raw-insn --no-addresses \
  build/x86_64-unknown-linux-gnu/stage0-std/x86_64-unknown-linux-gnu/release/deps/corebenches-2199e9a22e7b1f4a \
  | rustfilt &gt; baseline.asm

# switch to the branch with the changes
$ git switch feature-branch

# repeat the procedure above
$ ./x bench ...
$ objdump ... &gt; changes.asm

# compare output
$ kdiff3 baseline.asm changes.asm
</code></pre>
<p>This can also be applied to standalone benchmarks.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../development/building-and-debugging.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../development/how-to-write-documentation.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../development/building-and-debugging.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../development/how-to-write-documentation.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
